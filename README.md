<img width="468" height="25" alt="image" src="https://github.com/user-attachments/assets/25c7b0cd-165e-48f7-bf52-f1b6d4684c21" /># SR Linux EVPN Multi Homing - Layer 3

Baseline setup to play with EVPN multi homing (client 2)

Layer 3 multi homing where one ESI is associated with a IP-VRF

Client 2 CE device (Linux with FRR) will establish a BGP peering only with leaf1 and share the route 40.40.40.0/24, the rationale is that by default leaf3 will only have one path to 40.40.40.0/24 (via leaf1), however, with an Ethernet segment created at leaf1 and leaf2 (to which CE2 is multi homed) it is possible to have aliasing, allowing for load balancing form leaf3 towards both leaf1 and leaf2 to reach that 40.40.40.0/24 subnet

# Client baseline setup

![pic1](https://github.com/missoso/srl-mh-l3-evpn/blob/main/img_and_drawio/srl-mh-l3-evpn-detail.png)

Symmetric routing on the ip-vrf-12

CE-PE eBGP between leaf1 and ce2 only, multi-hop between 1.1.1.1 (lo0.1 on leaf1) and 2.2.2.2 (lo on CE) eBGP session

# Overlay, underlay and mgmt (just for reference)

![pic2](https://github.com/missoso/srl-mh-evpn/blob/main/img_and_drawio/underlay_overlay_mgmt.drawio.png)


# Without the Ethernet segment (ES)

Note: The configurations that are part of this repository contain the ES configuration, so when deploying it will already be there, to replicate the following output (without the ES) just remove it from leaf1 and leaf2 configurations (it is under system network-instance protocols)

Without the ES there would be one single path to 40.40.40.0/24 from leaf3:

```bash
A:leaf3# show route-table
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
IPv4 unicast route table of network instance ip-vrf-12
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+----------------------------------------+-------+------------+----------------------+----------+----------+---------+------------+-------------------------+-------------------------+-------------------------+----------------------------------------------------+
|                 Prefix                 |  ID   | Route Type |     Route Owner      |  Active  |  Origin  | Metric  |    Pref    |     Next-hop (Type)     |   Next-hop Interface    | Backup Next-hop (Type)  |             Backup Next-hop Interface              |
|                                        |       |            |                      |          | Network  |         |            |                         |                         |                         |                                                    |
|                                        |       |            |                      |          | Instance |         |            |                         |                         |                         |                                                    |
+========================================+=======+============+======================+==========+==========+=========+============+=========================+=========================+=========================+====================================================+
| 1.1.1.1/32                             | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32             |                         |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)        |                         |                         |                                                    |
| 2.2.2.2/32                             | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32             |                         |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)        |                         |                         |                                                    |
|                                        |       |            |                      |          |          |         |            | 10.0.1.2/32             |                         |                         |                                                    |
|                                        |       |            |                      |          |          |         |            | (indirect/vxlan)        |                         |                         |                                                    |
| 40.40.40.0/24                          | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32             |                         |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)        |                         |                         |                                                    |
| 172.17.2.0/24                          | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.4/32             |                         |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)        |                         |                         |                                                    |
| 192.168.11.0/31                        | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32             |                         |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)        |                         |                         |                                                    |
| 192.168.12.0/31                        | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.2/32             |                         |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)        |                         |                         |                                                    |
| 192.168.13.0/31                        | 2     | local      | net_inst_mgr         | True     | ip-      | 0       | 0          | 192.168.13.0 (direct)   | ethernet-1/1.0          |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            |                         |                         |                         |                                                    |
| 192.168.13.0/32                        | 2     | host       | net_inst_mgr         | True     | ip-      | 0       | 0          | None (extract)          | None                    |                         |                                                    |
|                                        |       |            |                      |          | vrf-12   |         |            |                         |                         |                         |                                                    |
+----------------------------------------+-------+------------+----------------------+----------+----------+---------+------------+-------------------------+-------------------------+-------------------------+----------------------------------------------------+
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
IPv4 routes total                    : 8
IPv4 prefixes with active routes     : 8
IPv4 prefixes with active ECMP routes: 1
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

# Ethernet segments (ES)

With the following ES created on both leaf1 and leaf2 (already part of the base configs)

```bash
system {
	network-instance {
            protocols {
                evpn {
                    ethernet-segments {
                        bgp-instance 1 {
                            ethernet-segment ES-2 {
                                type virtual
                                admin-state enable
                                esi 04:02:02:02:02:00:00:00:00:00
                                next-hop 2.2.2.2 {
                                    evi 101 {
                                    }
                                }
                            }
                        }
                    }
                }
                bgp-vpn {
                    bgp-instance 1 {
                    }
                }
            }
        }
}
```

And leaf3 now has two paths to reach 40.40.40.0/24

```bash
A:leaf3# show route-table
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
IPv4 unicast route table of network instance ip-vrf-12
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+-------------------------------------------+-------+------------+----------------------+----------+----------+---------+------------+--------------------------+--------------------------+--------------------------+---------------------------------------------------------+
|                  Prefix                   |  ID   | Route Type |     Route Owner      |  Active  |  Origin  | Metric  |    Pref    |     Next-hop (Type)      |    Next-hop Interface    |  Backup Next-hop (Type)  |                Backup Next-hop Interface                |
|                                           |       |            |                      |          | Network  |         |            |                          |                          |                          |                                                         |
|                                           |       |            |                      |          | Instance |         |            |                          |                          |                          |                                                         |
+===========================================+=======+============+======================+==========+==========+=========+============+==========================+==========================+==========================+=========================================================+
| 1.1.1.1/32                                | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32              |                          |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)         |                          |                          |                                                         |
| 2.2.2.2/32                                | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32              |                          |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)         |                          |                          |                                                         |
|                                           |       |            |                      |          |          |         |            | 10.0.1.2/32              |                          |                          |                                                         |
|                                           |       |            |                      |          |          |         |            | (indirect/vxlan)         |                          |                          |                                                         |
| 40.40.40.0/24                             | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32              |                          |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)         |                          |                          |                                                         |
|                                           |       |            |                      |          |          |         |            | 10.0.1.2/32              |                          |                          |                                                         |
|                                           |       |            |                      |          |          |         |            | (indirect/vxlan)         |                          |                          |                                                         |
| 172.17.2.0/24                             | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.4/32              |                          |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)         |                          |                          |                                                         |
| 192.168.11.0/31                           | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.1/32              |                          |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)         |                          |                          |                                                         |
| 192.168.12.0/31                           | 0     | bgp-evpn   | bgp_evpn_mgr         | True     | ip-      | 0       | 170        | 10.0.1.2/32              |                          |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            | (indirect/vxlan)         |                          |                          |                                                         |
| 192.168.13.0/31                           | 2     | local      | net_inst_mgr         | True     | ip-      | 0       | 0          | 192.168.13.0 (direct)    | ethernet-1/1.0           |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            |                          |                          |                          |                                                         |
| 192.168.13.0/32                           | 2     | host       | net_inst_mgr         | True     | ip-      | 0       | 0          | None (extract)           | None                     |                          |                                                         |
|                                           |       |            |                      |          | vrf-12   |         |            |                          |                          |                          |                                                         |
+-------------------------------------------+-------+------------+----------------------+----------+----------+---------+------------+--------------------------+--------------------------+--------------------------+---------------------------------------------------------+
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
IPv4 routes total                    : 8
IPv4 prefixes with active routes     : 8
IPv4 prefixes with active ECMP routes: 2
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

# Some terminology and acronyms

ES - Ethernet Segment

ESI - ES Identifier (zero means single homed CE)

AD - Auto discovery

EVI - EVPN Instance

# Routes announced by leaf1 (one of the PE's supporting the Ethernet segment)

Type 1 routes:

1 - Ethernet AD per EVI (tag 0), reachability for the ES allowing aliasing for the destination IP

2 - Ethernet AD per ES (tag maximum value), multi-homing mode, used for fast convergence (mass withdrawal)


Type 4 routes (only announced/imported by PE's that have the ES configured):

1 - Route representing the ES: ES2

Type 5 routes:

1 - Route for 2.2.2.2
2 - Other prefixes like the locally connected subnet on the interface facing the CE

```bash

# (10.0.2.1 is one of the two RR's)

A:leaf1# show network-instance default protocols bgp neighbor 10.0.2.1 advertised-routes evpn
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Peer        : 10.0.2.1, remote AS: 100, local AS: 100
Type        : static
Description : None
Group       : iBGP-overlay
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Origin codes: i=IGP, e=EGP, ?=incomplete
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 1 Ethernet Auto-Discovery Routes
+-----------------------------------------------------+--------------------------------+------------+-----------------------------------------------------+-----------------------------------------------------+---------+-----------------------------------------------------+
|                 Route-distinguisher                 |              ESI               |   Tag-ID   |                      Next-Hop                       |                         MED                         | LocPref |                        Path                         |
+=====================================================+================================+============+=====================================================+=====================================================+=========+=====================================================+
| 10.0.1.1:101                                        | 04:02:02:02:02:00:00:00:00:00  | 0          | 10.0.1.1                                            | -                                                   | 100     |                                                     |
| 10.0.1.1:101                                        | 04:02:02:02:02:00:00:00:00:00  | 4294967295 | 10.0.1.1                                            | -                                                   | 100     |                                                     |
+-----------------------------------------------------+--------------------------------+------------+-----------------------------------------------------+-----------------------------------------------------+---------+-----------------------------------------------------+
Type 4 Ethernet Segment Routes
+--------------------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+---------+--------------------------------------------+
|            Route-distinguisher             |              ESI               |               Originating-IP               |                  Next-Hop                  |                    MED                     | LocPref |                    Path                    |
+============================================+================================+============================================+============================================+============================================+=========+============================================+
| 10.0.1.1:0                                 | 04:02:02:02:02:00:00:00:00:00  | 10.0.1.1                                   | 10.0.1.1                                   | -                                          | 100     |                                            |
+--------------------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+---------+--------------------------------------------+
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 5 IP Prefix Routes
+---------------------+--------+---------------+----------+-----+---------+------+
| Route-distinguisher | Tag-ID |  IP-address   | Next-Hop | MED | LocPref | Path |
+=====================+========+===============+==========+=====+=========+======+
| 10.0.1.1:101        | 0      | 40.40.40.0/24 | 10.0.1.1 | -   | 100     |      |
| 10.0.1.1:101        | 0      | 192.168.11.0/ | 10.0.1.1 | -   | 100     |      |
|                     |        | 31            |          |     |         |      |
| 10.0.1.1:101        | 0      | 1.1.1.1/32    | 10.0.1.1 | -   | 100     |      |
| 10.0.1.1:101        | 0      | 2.2.2.2/32    | 10.0.1.1 | -   | 100     |      |
+---------------------+--------+---------------+----------+-----+---------+------+
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2 advertised Ethernet Auto-Discovery routes
0 advertised MAC-IP Advertisement routes
0 advertised Inclusive Multicast Ethernet Tag routes
1 advertised Ethernet Segment routes
4 advertised IP Prefix routes
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

# Routes announced by leaf2 (one of the PE's supporting the Ethernet segment)

Like leaf1 ....

Type 1 routes:

1 - Ethernet AD per EVI (tag 0), reachability for the ES allowing aliasing for the destination IP

2 - Ethernet AD per ES (tag maximum value), multi-homing mode, used for fast convergence (mass withdrawal)


Type 4 routes (only announced/imported by PE's that have the ES configured):

1 - Route representing the ES: ES2

Type 5 routes:

1 - Route for 2.2.2.2
2 - Locally connected subnet on the interface facing the CE

```bash

# (10.0.2.1 is one of the two RR's)

A:leaf2# show network-instance default protocols bgp neighbor 10.0.2.1 advertised-routes evpn
 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Peer        : 10.0.2.1, remote AS: 100, local AS: 100
Type        : static
Description : None
Group       : iBGP-overlay
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Origin codes: i=IGP, e=EGP, ?=incomplete
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 1 Ethernet Auto-Discovery Routes
+-----------------------------------------------------+--------------------------------+------------+-----------------------------------------------------+-----------------------------------------------------+---------+-----------------------------------------------------+
|                 Route-distinguisher                 |              ESI               |   Tag-ID   |                      Next-Hop                       |                         MED                         | LocPref |                        Path                         |
+=====================================================+================================+============+=====================================================+=====================================================+=========+=====================================================+
| 10.0.1.2:101                                        | 04:02:02:02:02:00:00:00:00:00  | 0          | 10.0.1.2                                            | -                                                   | 100     |                                                     |
| 10.0.1.2:101                                        | 04:02:02:02:02:00:00:00:00:00  | 4294967295 | 10.0.1.2                                            | -                                                   | 100     |                                                     |
+-----------------------------------------------------+--------------------------------+------------+-----------------------------------------------------+-----------------------------------------------------+---------+-----------------------------------------------------+
Type 4 Ethernet Segment Routes
+--------------------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+---------+--------------------------------------------+
|            Route-distinguisher             |              ESI               |               Originating-IP               |                  Next-Hop                  |                    MED                     | LocPref |                    Path                    |
+============================================+================================+============================================+============================================+============================================+=========+============================================+
| 10.0.1.2:0                                 | 04:02:02:02:02:00:00:00:00:00  | 10.0.1.2                                   | 10.0.1.2                                   | -                                          | 100     |                                            |
+--------------------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+---------+--------------------------------------------+
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 5 IP Prefix Routes
+---------------------+--------+-----------------+----------+-----+---------+------+
| Route-distinguisher | Tag-ID |   IP-address    | Next-Hop | MED | LocPref | Path |
+=====================+========+=================+==========+=====+=========+======+
| 10.0.1.2:101        | 0      | 192.168.12.0/31 | 10.0.1.2 | -   | 100     |      |
| 10.0.1.2:101        | 0      | 2.2.2.2/32      | 10.0.1.2 | -   | 100     |      |
+---------------------+--------+-----------------+----------+-----+---------+------+
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
2 advertised Ethernet Auto-Discovery routes
0 advertised MAC-IP Advertisement routes
0 advertised Inclusive Multicast Ethernet Tag routes
1 advertised Ethernet Segment routes
2 advertised IP Prefix routes
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

# Routes received by leaf3 (the other PE)

```bash

# (10.0.2.1 is one of the two RR's)

A:leaf3# show network-instance default protocols bgp routes evpn route-type 1 neighbor 10.0.2.1 summary
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Show report for the BGP route table of network-instance "default"
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Status codes: u=used, *=valid, >=best, x=stale, b=backup
Origin codes: i=IGP, e=EGP, ?=incomplete
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
BGP Router ID: 10.0.1.3      AS: 103      Local AS: 103
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 1 Ethernet Auto-Discovery Routes
+--------+-----------------------------------------------------+--------------------------------+------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+
| Status |                 Route-distinguisher                 |              ESI               |   Tag-ID   |                      neighbor                       |                      Next-hop                       |                        Label                        |
+========+=====================================================+================================+============+=====================================================+=====================================================+=====================================================+
| u*>    | 10.0.1.1:101                                        | 04:02:02:02:02:00:00:00:00:00  | 0          | 10.0.2.1                                            | 10.0.1.1                                            | 101                                                 |
| u*>    | 10.0.1.1:101                                        | 04:02:02:02:02:00:00:00:00:00  | 4294967295 | 10.0.2.1                                            | 10.0.1.1                                            | -                                                   |
| u*>    | 10.0.1.2:101                                        | 04:02:02:02:02:00:00:00:00:00  | 0          | 10.0.2.1                                            | 10.0.1.2                                            | 101                                                 |
| u*>    | 10.0.1.2:101                                        | 04:02:02:02:02:00:00:00:00:00  | 4294967295 | 10.0.2.1                                            | 10.0.1.2                                            | -                                                   |
+--------+-----------------------------------------------------+--------------------------------+------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+
4 Ethernet Auto-Discovery routes 4 used, 4 valid
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--{ running }--[  ]--
A:leaf3# show network-instance default protocols bgp routes evpn route-type 5 neighbor 10.0.2.1 summary
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Show report for the BGP route table of network-instance "default"
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Status codes: u=used, *=valid, >=best, x=stale, b=backup
Origin codes: i=IGP, e=EGP, ?=incomplete
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
BGP Router ID: 10.0.1.3      AS: 103      Local AS: 103
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 5 IP Prefix Routes
+--------+--------------------------------------------+------------+---------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+
| Status |            Route-distinguisher             |   Tag-ID   |     IP-address      |                  neighbor                  |                  Next-Hop                  |                   Label                    |                  Gateway                   |
+========+============================================+============+=====================+============================================+============================================+============================================+============================================+
| u*>    | 10.0.1.1:101                               | 0          | 40.40.40.0/24       | 10.0.2.1                                   | 10.0.1.1                                   | 101                                        | 0.0.0.0                                    |
| u*>    | 10.0.1.1:101                               | 0          | 192.168.11.0/31     | 10.0.2.1                                   | 10.0.1.1                                   | 101                                        | 0.0.0.0                                    |
| u*>    | 10.0.1.1:101                               | 0          | 1.1.1.1/32          | 10.0.2.1                                   | 10.0.1.1                                   | 101                                        | 0.0.0.0                                    |
| u*>    | 10.0.1.1:101                               | 0          | 2.2.2.2/32          | 10.0.2.1                                   | 10.0.1.1                                   | 101                                        | 0.0.0.0                                    |
| u*>    | 10.0.1.2:101                               | 0          | 192.168.12.0/31     | 10.0.2.1                                   | 10.0.1.2                                   | 101                                        | 0.0.0.0                                    |
| u*>    | 10.0.1.2:101                               | 0          | 2.2.2.2/32          | 10.0.2.1                                   | 10.0.1.2                                   | 101                                        | 0.0.0.0                                    |
| u*>    | 10.0.1.4:101                               | 0          | 172.17.2.0/24       | 10.0.2.1                                   | 10.0.1.4                                   | 101                                        | 0.0.0.0                                    |
+--------+--------------------------------------------+------------+---------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
7 IP Prefix routes 7 used, 7 valid
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

Detail about the route from leaf3 towards 40.40.40.0/24

```bash

# (10.0.2.1 is one of the two RR's) 

A:leaf3# show network-instance default protocols bgp routes evpn route-type 5 prefix 40.40.40.0/24 neighbor 10.0.2.1 detail
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Show report for the EVPN routes in network-instance  "default"
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Route Distinguisher: 10.0.1.1:101
Tag-ID             : 0
ip-prefix-len      : 24
ip-prefix          : 40.40.40.0/24
neighbor           : 10.0.2.1
path-id            : 0
Gateway IP         : 0.0.0.0
Received paths     : 1
  Path 1: <Best,Valid,Used,>
    ESI               : 04:02:02:02:02:00:00:00:00:00
    Label             : 101
    Route source      : neighbor 10.0.2.1 (last modified 9h18m59s ago)
    Route preference  : No MED, LocalPref is 100
    Atomic Aggr       : false
    BGP next-hop      : 10.0.1.1
    AS Path           :  i [201, 64601]
    Communities       : [target:100:101, mac-nh:1a:d5:04:ff:00:00, bgp-tunnel-encap:VXLAN]
    RR Attributes     : Originator-ID 10.0.1.1, Cluster-List is [10.10.10.10]
    Aggregation       : None
    Unknown Attr      : None
    Invalid Reason    : None
    Tie Break Reason  : none
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


```

## Deploying the lab

The lab is deployed with the [containerlab](https://containerlab.dev) project, where [`mh-l3-evpn.clab.yml`](https://github.com/missoso/srl-mh-l3-evpn/blob/main/mh-l3-evpn.clab.yml) file declaratively describes the lab topology.

```bash
# change into the cloned directory
# and execute
containerlab deploy --reconfigure
```

To remove the lab:

```bash
containerlab destroy --cleanup
```

## Access the lab

Leaf/spines: SSH through their management IP address or their hostname as defined in the topology file.

```bash
# reach a SR Linux leaf or a spine via SSH
ssh admin@leaf1
ssh admin@spine1
```
Linux clients cannot be reached via SSH, as it is not enabled, but it is possible to connect to them with a docker exec command.

```bash
# reach a Linux client via Docker
docker exec -it client1 bash
```

```bash
╭─────────┬────────────────────────────────────┬─────────┬────────────────╮
│   Name  │             Kind/Image             │  State  │ IPv4/6 Address │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client1 │ linux                              │ running │ 172.80.80.31   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client2 │ linux                              │ running │ 172.80.80.32   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client3 │ linux                              │ running │ 172.80.80.33   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client4 │ linux                              │ running │ 172.80.80.34   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf1   │ nokia_srlinux                      │ running │ 172.80.80.11   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf2   │ nokia_srlinux                      │ running │ 172.80.80.12   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf3   │ nokia_srlinux                      │ running │ 172.80.80.13   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf4   │ nokia_srlinux                      │ running │ 172.80.80.14   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ spine1  │ nokia_srlinux                      │ running │ 172.80.80.21   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ spine2  │ nokia_srlinux                      │ running │ 172.80.80.22   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
╰─────────┴────────────────────────────────────┴─────────┴────────────────╯
```


## Linux FRR specifics

To have BGP client 2 is a Linux FRR box, in the clab.yml:
```bash
client2:
      kind: linux
      image: quay.io/frrouting/frr:9.0.2
      binds:
        - configs/ce/ce2.cfg:/etc/frr/frr.conf
        - configs/ce/frr-daemons.conf:/etc/frr/daemons
      mgmt-ipv4: 172.80.80.32
      exec:
        - ip link set eth0 down
      group: server
```

Ethernet0 is disabled since we are not using the mgmt IP

The 1st bind is the startup configuration and the 2nd one is the daemons setup which defines what protocols will be active, the following config is from the file frr-daemons.conf:

```bash
bgpd=yes
ospfd=no
ospf6d=no
[...]
```

To change the configuration use the vtysh command, example:

```bash
:~$ docker exec -it client2 bash

client2:/# vtysh

client2# show running-config 

Building configuration...

Current configuration:
[...]]
```

